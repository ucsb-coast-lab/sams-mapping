<html>
<head>
  <meta charset="utf-8" />
  <title>Log File Data</title>
  <link rel="stylesheet" href="../assets/styles.css">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Load OpenLayers -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>

  <!-- Load CSV parsing library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <!-- Load Math library -->
  <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>

    <!-- Load a set of helper functions-->
    <script type="text/javascript" src="helper_fn.js"></script>

  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:100; bottom:0; right:0; left:0; }
  </style>
</head>
<body>
<a href="index.html"><img src="../assets/coast_logo.png" alt="coast_lab logo" style="width:300px;height:50 px;"></a>
<p>Please select a data file for processing:</p>
<input type="file" id="fileInput" name="csv_upload" />
<div id="map" class="map" style="width: 1000px; height: 600px; margin-top: 70px;"></div>
<div id="popup" class="ol-popup">
  <a href="#" id="popup-closer" class="ol-popup-closer"></a>
  <div id="popup-content"></div>
</div>
<h2>
    DrewUV Position Data:
</h2>

<script>
  document.getElementById('fileInput').addEventListener('change', readSingleFile);
  var map;

  const getData = async (text) => {
    let time=[]
    let ROSEpoch=[]
    let latitude=[]
    let longitude=[]
    let depth=[]
    let roll=[]
    let pitch=[]
    let yaw=[]

    var allRows = text.split(/\r?\n|\r/);
    allRows.map(row => {
      values = row.split(",")
      if(values[2] != "Latitude" && values[2] != "0"){
        time.push(values[0]);
        ROSEpoch.push(values[1]);
        latitude.push(parseFloat(values[2]));
        longitude.push(parseFloat(values[3]));
        depth.push(values[4]);
        roll.push(values[5]);
        pitch.push(values[6]);
        yaw.push(values[7]);
      }
    })

    return {time: time, ROSEpoch: ROSEpoch, latitude: latitude, longitude: longitude, 
      depth: depth, roll: roll, pitch: pitch, yaw: yaw}
  }

  const createMap = async (text) => {
    const data = await getData(text);

    if(data.latitude.length != 0 && data.longitude.length != 0){
      let lat = (math.max(data.latitude) + math.min(data.latitude))/2.0;
      let lon = (math.max(data.longitude) + math.min(data.longitude))/2.0;

      map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([lon, lat]),
          zoom: 18
        })
      });

      var style = new ol.style.Style({
          image: new ol.style.Circle({
            radius: 3,
            fill: new ol.style.Fill({color: 'red'}),
          }), 
          text: new ol.style.Text({
                offsetY: 15,
                scale: 2,
                fill: new ol.style.Fill({
                    color: '#black',
                })
          })
      })

      points = [];
      lines = [];
      for(var i=0; i<data.latitude.length; i++){
        point = new ol.Feature({label: parseFloat(data.yaw[i]).toFixed(2),
          geometry: new ol.geom.Point(ol.proj.fromLonLat([data.longitude[i], data.latitude[i]]))});
        points.push(point);
        if(i < data.latitude.length-1){
          start = ol.proj.fromLonLat([data.longitude[i], data.latitude[i]]);
          end = ol.proj.fromLonLat([data.longitude[i+1], data.latitude[i+1]])
          lines.push(new ol.Feature({geometry: new ol.geom.LineString([start, end])}));
        }
      }

      var line_layer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: lines
        }),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'orange',
            width: 1,
          })
        })
      });
      map.addLayer(line_layer);

      var point_layer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: points
        }),
        style: styleFunction
      });
      map.addLayer(point_layer);

      var container = document.getElementById('popup');
      var content = document.getElementById('popup-content');
      var closer = document.getElementById('popup-closer');

      var overlay = new ol.Overlay({
        element: container,
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
      });
      map.addOverlay(overlay);
    }
  }
</script>

</body>
</html>
