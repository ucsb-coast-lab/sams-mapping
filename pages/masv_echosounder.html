<html>
<head>
  <meta charset="utf-8" />
  <title>Log File Data</title>
  <link rel="stylesheet" href="../assets/styles.css">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Load OpenLayers -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>

  <!-- Load CSV parsing library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <!-- Load Math library -->
  <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>

  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:100; bottom:0; right:0; left:0; }
  </style>
</head>
<body>
<a href="index.html"><img src="../assets/coast_logo.png" alt="coast_lab logo" style="width:300px;height:50 px;"></a>
<p>Please select a data file for processing:</p>
<input type="file" id="fileInput" name="csv_upload" />
<div id="map" class="map" style="width: 1000px; height: 600px; margin-top: 70px;"></div>
<div id="popup" class="ol-popup">
  <a href="#" id="popup-closer" class="ol-popup-closer"></a>
  <div id="popup-content"></div>
</div>
<h2>
    MASV echosounder data:
</h2>

<!-- Load a set of helper functions-->
<script type="text/javascript" src="helper_fn.js"></script>

<script>
  document.getElementById('fileInput').addEventListener('change', readSingleFile);
  var map;

  const createMap2 = async (text) => {
    var latTotal = 0;
    var lonTotal = 0;
    try{      
      json = JSON.parse(text);
      features = json.features;
      features.forEach(feature => {
        feature.geometry.coordinates = ol.proj.fromLonLat([feature.geometry.coordinates[1], feature.geometry.coordinates[0]]);
        latTotal += feature.geometry.coordinates[1];
        lonTotal += feature.geometry.coordinates[0];
      })
    }catch(e){
      //Handles old format where each line is a feature
      var allRows = text.split(/\r?\n|\r/);
      var features = [];
      allRows.map(row => {
        try{
          if(row !== ""){
            row = JSON.parse(row);
            row.geometry.coordinates = ol.proj.fromLonLat([row.geometry.coordinates[1], row.geometry.coordinates[0]]);
            latTotal += row.geometry.coordinates[1];
            lonTotal += row.geometry.coordinates[0];
            features.push(row);
          }
        }catch (e){
          alert("Failed to load file, must be a .csv or .geojson");
        }
      })
    }

    const geojson = {
      'type': 'FeatureCollection',
      'crs': {
        'type': 'name',
        'properties': {
          'name': 'EPSG:3857',
        },
      },
      'features': features,
    };

    map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],
      view: new ol.View({
        center: [lonTotal/features.length, latTotal/features.length],
        zoom: 16
      })
    });

    var styles = {
      'Point': new ol.style.Style({
        image: new ol.style.Circle({
            radius: 2,
            fill: new ol.style.Fill({color: 'red'}),
          }),
      }),  
    };

    var styleFunction = function (feature) {
      return styles[feature.getGeometry().getType()];
    };

    var vectorSource = new ol.source.Vector({
      features: new ol.format.GeoJSON().readFeatures(geojson),
    });

    var vectorLayer = new ol.layer.Vector({
      source: vectorSource,
      style: styleFunction,
    });
    map.addLayer(vectorLayer);
  }

</script>

</body>
</html>
