<html>
<head>
  <meta charset="utf-8" />
  <title>Log File Data</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Load Leaflet from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
  integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
  crossorigin=""></script>

  <!-- Load OpenLayers -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.3.2/dist/esri-leaflet.js"
  integrity="sha512-6LVib9wGnqVKIClCduEwsCub7iauLXpwrd5njR2J507m3A2a4HXJDLMiSZzjcksag3UluIfuW1KzuWVI5n/cuQ=="
  crossorigin=""></script>

  <!-- Load CVS parsing library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <!-- Load Math library -->
  <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>

  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:100; bottom:0; right:0; left:0; }
  </style>
</head>
<body>
<label for="log_file">Choose a log file:</label>
<select name="log_files" id="log_files" form="log_files_form">
  <option value="2021-03-18-21-52-45_log.csv">2021-03-18-21-52-45_log.csv</option>
  <option value="2021-03-18-22-20-36_log.csv">2021-03-18-22-20-36_log.csv</option>
  <option value="2021-03-18-22-59-45_log.csv">2021-03-18-22-59-45_log.csv</option>
  <option value="2021-03-18-23-09-50_log.csv">2021-03-18-23-09-50_log.csv</option>
  <option value="2021-03-18-23-13-16_log.csv">2021-03-18-23-13-16_log.csv</option>
</select>
<div id="map" class="map" style="width: 1000px; height: 600px; margin-top: 10px;"></div>
<div id="popup" class="ol-popup">
  <a href="#" id="popup-closer" class="ol-popup-closer"></a>
  <div id="popup-content"></div>
</div>
<a href="../welcome.html"><img src="../coast_logo.png" alt="coast_lab logo" style="width:300px;height:50 px;"></a>
<font face="ubuntu">
<h2>
    Log file data points:
</h2>

<script>
  const getText = async (fileName) => {    
    return $.ajax({url: 'logs/' + fileName, dataType: 'text',})
  }

  const getData = async (text) => {
    let time=[]
    let ROSEpoch=[]
    let latitude=[]
    let longitude=[]
    let depth=[]
    let roll=[]
    let pitch=[]
    let yaw=[]

    var allRows = text.split(/\r?\n|\r/);
    allRows.map(row => {
      values = row.split(",")
      if(values[2] != "Latitude" && values[2] != "0"){
        time.push(values[0]);
        ROSEpoch.push(values[1]);
        latitude.push(parseFloat(values[2]));
        longitude.push(parseFloat(values[3]));
        depth.push(values[4]);
        roll.push(values[5]);
        pitch.push(values[6]);
        yaw.push(values[7]);
      }
    })

    return {time: time, ROSEpoch: ROSEpoch, latitude: latitude, longitude: longitude, 
      depth: depth, roll: roll, pitch: pitch, yaw: yaw}
  }

  const createMap = async (fileName) => {
    const text = await getText(fileName);
    const data = await getData(text);

    if(data.latitude.length != 0 && data.longitude.length != 0){
      let lat = (math.max(data.latitude) + math.min(data.latitude))/2.0;
      let lon = (math.max(data.longitude) + math.min(data.longitude))/2.0;

      map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([lon, lat]),
          zoom: 18
        })
      });

      var style = new ol.style.Style({
          image: new ol.style.Circle({
            radius: 3,
            fill: new ol.style.Fill({color: 'red'}),
          }), 
          text: new ol.style.Text({
                offsetY: 15,
                scale: 2,
                fill: new ol.style.Fill({
                    color: '#black',
                })
          })
      })

      points = [];
      lines = []
      for(var i=0; i<data.latitude.length; i++){
        point = new ol.Feature({label: parseFloat(data.yaw[i]).toFixed(2),
          geometry: new ol.geom.Point(ol.proj.fromLonLat([data.longitude[i], data.latitude[i]]))});
        points.push(point);
        if(i < data.latitude.length-1){
          start = ol.proj.fromLonLat([data.longitude[i], data.latitude[i]]);
          end = ol.proj.fromLonLat([data.longitude[i+1], data.latitude[i+1]])
          lines.push(new ol.Feature({geometry: new ol.geom.LineString([start, end])}));
        }
      }

      var line_layer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: lines
        }),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'orange',
            width: 1,
          })
        })
      });
      map.addLayer(line_layer);

    

      function styleFunction(feature) {
        style.getText().setText(feature.get('label'));
        return style;
      }   


      var point_layer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: points
        }),
        style: styleFunction
      });
      map.addLayer(point_layer);

      var container = document.getElementById('popup');
      var content = document.getElementById('popup-content');
      var closer = document.getElementById('popup-closer');

      var overlay = new ol.Overlay({
        element: container,
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
      });
      map.addOverlay(overlay);

      //old code to make Leaflet Map
      // var map = L.map('map').setView([lat, lon], 15);
      // L.esri.basemapLayer('Topographic').addTo(map);

      // var LeafIcon = L.Icon.extend({
      //   options: {
      //     iconSize:     [10, 10],
      //     iconAnchor:   [15, 15],
      //     popupAnchor:  [-7.5, -15]
      //   }
      // });
      // var xIcon = new LeafIcon({
      //   iconUrl: '../xIcon.png'
      // })

      // for(var i=0; i<data.latitude.length; i++){
        // var point = L.marker([data.latitude[i], data.longitude[i]]).addTo(map);//.bindPopup("Pier: ").openPopup();
        // point.bindPopup(
        //   "ROSEpoch: " + data.ROSEpoch[i] +
        //   "\nlatitude: "  + data.latitude[i] +
        //   "\nlongitude: " + data.longitude[i] +
        //   "\ndepth: " + data.depth[i] +
        //   "\nroll: " + data.roll[i] +
        //   "\npitch: " + data.pitch[i] +
        //   "\nYaw: " + data.yaw[i]
        // );
        // point.setIcon(xIcon);
      // }

      // var popup = L.popup();
      // function onMapClick(e) {
      //   popup
      //     .setLatLng(e.latlng)
      //     .setContent(e.latlng.toString())
      //     .openOn(map);
      //   }
      // map.on('click', onMapClick);
    }
  }

  var map;

  var e = document.getElementById("log_files");
  function show(){
    var selected = e.options[e.selectedIndex].value;
    map.setTarget(null);
    createMap(selected)
  }
  e.onchange=show;

  let set = false;
  if(!set){
    set = true;
    createMap("2021-03-18-21-52-45_log.csv");
  }
</script>

</body>
</html>
